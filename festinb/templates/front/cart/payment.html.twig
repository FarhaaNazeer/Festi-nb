{% extends 'base.html.twig' %}

{% block title %} Festinb | Paiement{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('stripe_scss') }}
{% endblock %}

{% block content %}
    <div class="useful-width">
        <div class="stripe">
            <form action="{{ path('app_front_cart_subscription', {'uuid' : cart.uuid}) }}" method="post" id="payment-form">
                <div id="card-elements"></div>
                <div id="card-errors" role="alert"></div>
                <button type="submit" class="btn--cart-modal">Payer - {{ cart.amount|number_format(2, '.', '.') }}â‚¬</button>
            </form>
            <script src="https://js.stripe.com/v3"></script>

            <script>
                {% if 'dev' == app_environement %}
                    let stripeToken = "{{ stripe_public_key_test }}"
                {%  endif %}

                let stripe = Stripe(stripeToken);
                let elements = stripe.elements();

                let subscription = "{{ cart.uuid }}";
                let clientSecret = "{{ intentSecret }}"
                let cardHolderName = "{{ app.user.lastname }}"
                let cardHolderEmail = "{{ app.user.email }}"

                console.log('Client secret : ' + clientSecret);

                let customStyle = {
                    base: {
                        fontSize: '16px',
                        color: "#7f7f7f"
                    }
                };

                // Display form
                let card = elements.create('card', {style: customStyle});
                card.mount("#card-elements");

                // Handle errors
                card.addEventListener('change', function (event){

                    let displayError = document.getElementById('card-errors');

                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });

                let form = document.getElementById('payment-form');

                form.addEventListener('submit', function (event) {
                    event.preventDefault();

                    stripe.confirmCardPayment(clientSecret, {
                        payment_method: {
                            card: card,
                            billing_details: {
                                name: cardHolderName,
                                email: cardHolderEmail
                            }
                        }
                    }).then(function(result){
                       console.log(result);
                    });
                });

            </script>
       </div>
    </div>
{% endblock %}

{#{% block javascripts %}#}
{#    {{ parent() }}#}

{#{% endblock %}#}